## 第一部分 HTTP：Web的基础
### HTTP概述
一句话：Web客户端向服务器发送HTTP请求，服务器给客户端返回HTTP响应
#### 资源，Web 资源，Web resource
- 媒体类型，MIME type，原本用于不同的电子邮件系统之间的报文搬移。回应首部（headers）， *Content-type*
- *URI* (Uniform Resource Identifier) 主要是URL，URN还停留在试验阶段。URL的标准格式包含3个：方案、地址、资源
#### 事务
一个HTTP事务由一个请求命令和一个响应结果组成，通过HTTP报文（message）进行
- HTTP方法（method）：GET POST 
- 状态码：200 302 404 500（4xx 客户端请求出错，5xx 服务器端出错）
#### 报文
- 起始行 
- 首部字段（字典或者json表示，key-value之间冒号分隔，以一个空行结束）
- 主体（可选，包含了所有类型的数据）
#### 连接
报文通过传输控制协议（Transmission Control Protocol TCP）连接，TCP提供了：无差错的数据传输、按序传输、未分段的数据流，下面的协议栈可以看出，HTTPS在HTTP和TCP之间插入一个安全通道？
> HTTP网络协议栈
> 
|名字|层|
|---|----|
|HTTP|应用层|
|TCP|传输层|
|IP|网络层|
|链路接口|数据链路层|
|物理网络硬件|物理层|

发送报文之前，需要用网络协议（Internet Protocol，IP）地址和端口号在客户端和服务器之间建立一条TCP/IP连接。
**浏览器连接处理**
1. 浏览器从URL中解析出服务器的主机名
2. 浏览器将服务器的主机名转换成服务器的IP地址（DNS）
3. 浏览器将端口号（如果有的话）从URL中解析出来
4. 浏览器建立一条与Web服务器的TCP连接（三次握手）
5. 浏览器向服务器发送一条HTTP请求报文
6. 服务器向浏览器回送一条HTTP响应报文
7. 关闭连接，浏览器显示文档
#### Web的结构组件
- 代理 位于客户端和服务器之间的HTTP中间实体
- 缓存 HTTP的仓库
- 网关 连接其他应用程序的特殊Web服务器（HTTP/FTP）
- 隧道 对HTTP通信报文进行盲转发的特殊代理
- Agent代理 发动自动HTTP请求的半智能Web客户端
### URL与资源
URL的三部分（复读）：URL方案（scheme），服务器的位置，资源路径，最重要的三部分 scheme、host、path
*<shceme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>*
#### 各种令人头疼的字符
requests中填入params可以自动转url，主要是把一些字符编码。（转义序列）
> URL的未来，URN的未来
### HTTP报文
#### 报文流
流入（inbound）和流出（outbound）来描述事务处理的方向
#### 报文的组成部分
- start line 起始行
- header 首部
- body 主体
#### 报文的语法
请求报文：
<method> <request-URL> <version>
<headers>
响应报文:
<version> <status> <reason-phrase>
<headers>

<entity-body>
起始行：请求行/响应行 | 方法，状态码，原因短语，版本号
#### 方法
GET 请求服务器发送某个资源。HEAD 类似但要求服务器在响应中只返回首部，不会返回实体。
POST 起初用来向服务器输入数据（用于支持填表）TRACE 用于跟踪请求
OPTIONS 请求服务器告知其支持的各种功能 DELETE请服务器删除请求URL所指定的资源
#### 状态码
100-199 信息性状态码 ： 100 Continue
200-299 成功状态码： 200 OK
300-399 重定向状态码：304 Not Modified
400-499 客户端错误状态码：400 Bad Request 
500-599 服务器错误状态码：500 Internal Server Error
#### 首部
- 通用首部
- 请求首部
- 响应首部
- 实体首部
### 连接管理
#### TCP连接
参考前面的“浏览器连接处理”，安全层（SSL/TSL）位于TCP之上，HTTP之下。
HTTP要传送一条报文时，会以流的形式将报文数据的内容通过一条打开的TCP连接按序传输。TCP收到数据流之后，会将数据流砍成被称作为段的小数据块，并将段封装在IP分组中，通过因特网进行传输。所有这些工作都是由TCP/IP软件来处理的。每个IP分组中都包括：一个IP分组首部，一个TCP段首部和一个TCP数据块
> 用TCP套接字编程（待补充）
#### TCP性能
##### HTTP事务的时延
1. 将主机名转换成IP地址
2. 建立TCP请求的时延
3. 传输请求，读取请求，处理请求
4. 回送HTTP响应
##### TCP连接的握手时延
在发送数据之前，TCP要传送两个分组来建立连接
（1）请求新的TCP连接时，客户端要向服务器发送一个小的TCP分组。这个分组中设置了一个特殊的SYN标记，说明这是一个连接请求。
（2）如果服务器接受了这个连接，就会对一些连接参数进行计算，并向客户端回送一个TCP分组，这个分组中的SYN和ACK标记都被置位，说明连接请求已被接受
（3）最后，客户端向服务器回送一条确认信息，通知它连接已成功建立。现代的TCP栈都允许客户端在这个确认分组中发送数据
##### 延迟确认
##### TCP慢启动
#### HTTP连接的处理
- 并行连接
- 持久连接（盲中继的问题）
- 管道化连接
#### 关闭连接的奥秘
## 第二部分：HTTP结构
> 介绍了HTTP服务器、代理、缓存、网关和机器人应用程序

[Netcraft调查](http://www.netcraft.com/survey/)显示，nginx超过Apache成为占比第一，其次是Microsoft和Google
### Web服务器
#### 实际的Web服务器会做些什么
1. 建立连接——接受一个客户端连接，或者如果不希望与这个客户端建立连接，就将其关闭
2. 接受请求——从网络中读取一条HTTP请求报文
3. 处理请求——对请求报文进行解释，并采取行动
4. 访问资源——访问报文中指定的资源
5. 构建响应——创建带有正确首部的HTTP响应报文
6. 发送响应——将响应回送给客户端
7. 记录事务处理过程——将与已完成事务有关的内容记录在一个日志的文件中（nginx.access.log）
**连接的输入/输出处理结构**
- 单线程I/O结构
- 多线程I/O结构
- 复用的I/O结构
- 复用的多线程I/O结构
### 代理
#### 代理与网关的对比
严格来说，代理连接的是两个或多个使用相同协议的应用程序，而网关连接的则是两个或多个使用不同协议的端点。网关扮演的是“协议转换器”的角色，即使客户端和服务器使用的是不同的协议，客户端也可以通过它完成与服务器之间的事务处理。
#### 代理服务器的部署
出口代理、访问（入口）代理、反向代理、网络交换代理
反向代理部署在网络边缘，在Web服务器之前，作为替代物使用。（取代原始服务器的代理服务器）
#### 客户端的代理设置
手工配置、预先配置浏览器、代理的自动配置（Proxy Auto-Configuration，PAC）、WPAD的代理发现
- 代理URI与服务器URI的不同，设置代理需要发送完整URI（给代理）
- 没有代理时、有显式代理时、有拦截代理时URI的解析
### 缓存
- 缓存减少了冗余的数据传输，节省了你的网络费用
- 缓存缓解了网络瓶颈的问题。不需要更多的带宽就能够更快地加载页面
- 缓存降低了对原始服务器的要求。
- 缓存降低了距离时延，因为从较远的地方加载页面会更慢一点。
#### 收到GET If-Modified-Since请求
- 再验证命中
- 再验证未命中
- 对象被删除
#### 缓存的处理步骤
1. 接收——缓存从网络中读取抵达的请求报文
2. 解析——缓存对报文进行解析，提取出URL和各种首部
3. 查询——缓存查看是否有本地副本可用，如果没有，就获取一份副本（并将其保存在本地）
4. 新鲜度检测——缓存查看已缓存副本是否足够新鲜，如果不是，就询问服务器是否有任何更新
5. 创建响应——缓存会用新的首部和已缓存的主体来构建一条响应报文
6. 发送——缓存通过网络将响应发回给客户端
7. 日志——缓存可选地创建一个日志文件条目来描述这个事务
#### 文档过期
Cache-Control Expires
**服务器再验证：**
- 如果再验证显示的内容发生了变化，缓存会获取一份新的文档副本，并将其存储再旧文档的位置上，然后将文档发送给客户端
- 如果再验证显示内容没有发生变化，缓存只需要获取新的首部，包括一个新的过期日期，并对缓存中的首部进行更新就行了
**用条件方法进行再验证：**
- If-Modified-Since:Date再验证
- If-None-Match：实体标签再验证
### 集成点：网关、隧道及中继
网关（gateway），网关是资源和应用程序之间的粘合剂，抽象出了一种能够到达资源的方法。应用程序可以（通过HTTP或其他已定义的接口）请求网关来处理某条请求，网关可以提供一条响应。
*<客户端协议>/<服务器端协议>*
服务器端网关（server-side gateway）：通过HTTP与客户端对话，通过其他协议与服务器通信，客户端网关（client-side gateway）：通过其他协议与客户端对话，通过HTTP与服务器通信
网关的三个示例：HTTP/FTP服务器端FTP网关，HTTPS/HTTP客户端安全网关，HTTP/CGI服务器端应用程序网关
第一个流行的应用程序网关API就是通用网关接口（Common Gateway Interface，CGI）
#### 隧道
SSL隧道与HTTP/HTTPS网关的对比
#### 中继
### Web机器人
爬虫（crawler）或蜘蛛（spider）
爬虫开始访问的URL初始集合被称作根集（root set）挑选根集时，应该从足够多不同的站点中选择URL，这样，爬遍所有的链接才能最终到达大部分你感兴趣的Web页面
循环与复制，环路对爬虫是有害的
- 它们会使爬虫陷入可能会将其困住的循环中。
- 爬虫不断地获取相同的页面时，另一端的Web服务器也在遭受着打击。
- 即使循环自身不是什么问题，爬虫也是在获取大量重复的页面（dups）
大规模Web爬虫对其访问过的地址进行管理时使用的一些有用的技术
- 树和散列表
- 有损的存在位图
- 检查点
- 分类
**拒绝机器人访问**
robots.txt
**搜索引擎**
全文索引，对结果进行排序并提供查询结果，欺诈
### HTTP-NG